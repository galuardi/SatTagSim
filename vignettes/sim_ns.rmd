---
title: "Simulate using SatTagSim"
author: "Benjamin Galuardi"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    fig_caption: yes
vignette: >
  %\VignetteIndexEntry{Simulate using SatTagSim}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
##Simulation of Nova Scotia tagged Atlantic bluefin tuna \emph{(Thunnus thynnus)} and get seasonal transition matrices from a 7-box spatial strata.


---
load background data and set up parallel

```{r eval = T, echo = F}
library(SatTagSim)
data(box7)
data(rmask)
# sst = rmask2array(rmask)
mcoptions = setup.parallel()
```


---
## Spatial strata in this package
7-box strata from the Kerr et al. operational model

```{r, fig.width = 7, fig.height= 5, fig.show = 'asis', echo = F, eval = T}
# library(fields)
# library(raster)
# library(SatTagSim)
# data(box7)
plot(box7, xlim = c(-100, 40), ylim = c(0,65))
world(add=T)
plot(box7, add = T, border = 'salmon', lwd=2)
text(coordinates(box7)[,1], coordinates(box7)[,2], box7@data[,3], cex = 2, col = 'darkred')
degAxis(1)
degAxis(2)
box()
title('7-box')
```

---
## Environmental data in this package
World Ocean Atlas sea surface temperature is included. A raster mask, predicated on suitable temperature habitat in each month, is also included. 

```{r echo = F, eval = T, fig.show = 'asis', fig.width = 7, fig.height= 5}
library(fields)
library(raster)
data(rmask)
data(woasst)
sstmat = list(lon = sort(unique(coordinates(rmask[[1]])[,1]))
                ,lat = sort(unique(coordinates(rmask[[1]])[,2]))
                # ,data = as.array(rmask)
                )
  sstdata = array(NA, dim = dim(rmask)[c(2,1,3)])
  for(i in 1:(dim(rmask)[3])) sstdata[,,i] = rot90(as.array(rmask)[,,i],3)
  # sstmat$data = apply(sstdata, 1:2, sum, na.rm = T)

sstmat$data = sstdata
# par(mfrow=c(1,2))
par(mar = c(2,2,2,4))
image.plot(woasst$lon, woasst$lat, apply(woasst$sst, 1:2, mean, na.rm = T))
world(add=T) 
title('World Ocean Atlas mean temperature')

image.plot(sstmat$lon, sstmat$lat, apply(sstmat$data, 1:2, sum, na.rm=T), xlim = c(-100, 40), ylim = c(0,65))
world(add=T, col = 'white')
title('Number of months with suitable surface temperature')
```

---
## Set up the temperature constraint field. 

This can be done several ways. The preferred method is to use a running average of suitability, by month, for 12 months. In this manner, there is not a hard limit as to whether a fish may be in the area or not, but does provide a selection criteria that is weighted toward the suitability in that month.

The temperature field provided `data(rmask)` is a surface temperature suitability for bluefin tuna, based on tag measured temperatures. 

```{r echo = F, eval = T, fig.show = 'asis', fig.width = 7, fig.height= 5, fig.cap='Tag Measured Temperatures'}
dat = nsfish

par(mfrow=c(3,4))
for(i in 1:12){
	plot(ecdf(dat$MaxTemp[dat$Month==i]), main = month.name[i])
	# hist(dat$MaxTemp[seasidx[[i]]], breaks=30, main=seasons[i], xlim = c(0, 40))
	mtemp = mean(dat$MaxTemp[dat$Month==i], na.rm=T)
	sdtemp = sd(dat$MaxTemp[dat$Month==i], na.rm=T)
	abline(v=mtemp, lwd=2, col=2)
	abline(v=quantile(dat$MaxTemp[dat$Month==i], c(0.025, .975),na.rm=T), lwd=2, col=4)
	# print(quantile(dat$MaxTemp[dat$Month==i], c(0.025, .975),na.rm=T))
}
```


Based on the plots, a range of $10-28\,^{\circ}\mathrm{C}$ were chosen 


```{r echo = F, eval = F, fig.show = 'asis', fig.width = 7, fig.height= 5}
# SET UP THE WOA SST AS A 3D ARRAY
# Function does not work!!!
# sstmat = rmask2array(rmask)
sstmat = list(lon = sort(unique(coordinates(rmask[[1]])[,1]))
                ,lat = sort(unique(coordinates(rmask[[1]])[,2]))
                # ,data = as.array(rmask)
                )
  sstdata = array(NA, dim = dim(rmask)[c(2,1,3)])
  for(i in 1:(dim(rmask)[3])) sstdata[,,i] = rot90(as.array(rmask)[,,i],3)
  # sstmat$data = apply(sstdata, 1:2, sum, na.rm = T)

sstmat$data = sstdata
## If using the running average suitability
{
  sstm = sstdata
  for(i in 2:11){
   sstm[,,i] = apply(sstdata[,,c(i-1,i,i+1)], 1:2, sum, na.rm = T)
  }
  sstm[,,1] = apply(sstdata[,,c(12, 1, 2)], 1:2, sum, na.rm = T)
  sstm[,,12] = apply(sstdata[,,c(11, 12, 1)], 1:2, sum, na.rm = T)

  sstmat$data = sstm
  rm(sstdata, sstm)
}


par(mfrow=c(3,4))
for(i in 1:12){
  par(mar=c(2,2,2,2))
 image(sstmat$lon, sstmat$lat, sstmat$data[,,i], col = tim.colors(4))
 world(add=T)
}
```

Struture of the sst array: 
```{r, echo = F, eval = T}
str(sstmat)
```

## More Examples


> "He who gives up [code] safety for [code] speed deserves neither."
([via](https://twitter.com/hadleywickham/status/504368538874703872))

footnotes^[A footnote here.]
