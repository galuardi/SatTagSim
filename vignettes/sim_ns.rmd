---
title: "Simulate using SatTagSim"
author: "Benjamin Galuardi"
date: '`r Sys.Date()`'
output:
  pdf_document:
    fig_caption: yes
  html_document: null
---
<!-- rmarkdown::html_vignette: -->
<!--     fig_caption: yes -->
<!-- vignette: > -->
<!--   %\VignetteIndexEntry{Simulate using SatTagSim} -->
<!--   %\VignetteEngine{knitr::rmarkdown} -->
<!--   %\VignetteEncoding{UTF-8} -->

##Simulation of Nova Scotia tagged Atlantic bluefin tuna \emph{(Thunnus thynnus)} and get seasonal transition matrices from a 7-box spatial strata.


```{r, global_options, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, 
											message=FALSE, cache=TRUE,
											progress = TRUE, verbose = FALSE, fig.width = 8, fig.height = 6)

```	

load background data and set up parallel

```{r, setup_data, eval = T}
library(SatTagSim)
library(analyzepsat)
library(rworldmap)
library(rworldxtra)
library(knitr)
data(box7)
data(box11)
data(rmask)
data(nsfish)
data(myramps)
map = rworldmap::getMap(resolution = 'high')
# sst = rmask2array(rmask)
# mcoptions = setup.parallel()
```

## Tag data:
```{r, plot_tags, fig.width = 9, fig.height = 6}
par(mar = c(3,3,3,6))
plot(nsfish, col = month.colors[nsfish$Month,2], pch = 19, cex = .6, ylim = c(20, 50), xlim = c(-100, 0))
plot(map, add=T, col = 'cornsilk4', fill=T)
degAxis(1)
degAxis(2)
box()
 .add.month.scale()
```

\newpage


```{r}
# length of deployments
ddply(as.data.frame(nsfish), c('TagID'), function(x) data.frame(nmonths = length(unique(x$Month))))
```


\newpage

## plot as raster:
```{r, plot_tags_raster, fig.width = 8, fig.height = 6}

make.tag.raster  <- function(simdat, xmn = -100, xmx = 30, ymn = 0, ymx = 60, boxsize= 60){
  # require(raster)
  if(class(simdat)=="SpatialPointsDataFrame"){
      simdat = as.data.frame(simdat)
  }
  r = raster(nrow=(ymx-ymn)*60/boxsize, ncol= (xmx-xmn)*60/boxsize, xmn = xmn, xmx = xmx, ymn = ymn, ymx = ymx)
  simdat$CID = 1
  coordinates(simdat) = ~Longitude+Latitude
  sr = rasterize(simdat, r, field = 'CID', fun='count') #[[1]]
  return(sr)
}

r = dlply(as.data.frame(nsfish), 'Month', function(x) make.tag.raster(x))

r = make.tag.raster(nsfish)

library(viridis)
plot(r, col = rev(viridis(100)), ylim = c(20, 50), xlim = c(-100, 0), axes =F)
world(add=T, col = 'cornsilk4', fill=T)
degAxis(1)
degAxis(2)
box()

```

\newpage

## Spatial strata in this package
7-box strata from the Kerr et al. operational model

```{r, plot_box7, fig.show = 'asis', echo = F, eval = T, fig.width = 8, fig.height = 6, fig.cap = '7- box stratification from Kerr et al. (2016) operational model'}
# library(fields)
# library(raster)
# library(SatTagSim)
# data(box7)
plot(box7, xlim = c(-100, 40), ylim = c(0,65))
world(add=T)
plot(box7, add = T, border = 'salmon', lwd=2)
text(coordinates(box7)[,1], coordinates(box7)[,2], box7@data[,3], cex = 2, col = 'darkred')
degAxis(1)
degAxis(2)
box()
title('7-box')
```

\newpage

```{r, plot_box11, fig.show = 'asis', echo = F, eval = T, fig.width = 8, fig.height = 6, fig.cap = '11- box stratification from Lauretta et al. (2016) spatial summary'}

plot(box11, xlim = c(-100, 40), ylim = c(-50,80))
world(add=T)
plot(box11, add = T, border = 'salmon', lwd=2)

lpts = coordinates(box11)
lpts[4,2] = 35
lpts[9,] = c(-25, 25)

text(lpts[,1], lpts[,2], box11@data[,3], cex = 2, col = 'darkred')
degAxis(1)
degAxis(2)
box()
title('11-box')
```


\newpage

## Environmental data in this package
World Ocean Atlas sea surface temperature is included. A raster mask, predicated on suitable temperature habitat in each month, is also included. 

```{r, plot_WOA, eval = T, fig.show = 'asis', fig.cap = 'World Ocean Atlas (2013) mean temperature'}
library(fields)
library(raster)
library(matlab)
data(rmask)
data(woasst)
sstmat = list(lon = sort(unique(coordinates(rmask[[1]])[,1]))
                ,lat = sort(unique(coordinates(rmask[[1]])[,2]))
                # ,data = as.array(rmask)
                )
  sstdata = array(NA, dim = dim(rmask)[c(2,1,3)])
  for(i in 1:(dim(rmask)[3])) sstdata[,,i] = rot90(as.array(rmask)[,,i],3)
  # sstmat$data = apply(sstdata, 1:2, sum, na.rm = T)

sstdata[is.na(sstdata)] = 0
sstmat$data = sstdata

# par(mfrow=c(1,2))
par(mar = c(2,2,2,4))
image.plot(woasst$lon, woasst$lat, apply(woasst$sst, 1:2, mean, na.rm = T), axes = F)
map(add = T, col = 'white', fill = T)
# world(add=T) 
degAxis(1)
degAxis(2)
box()
title('World Ocean Atlas mean temperature')

# image.plot(sstmat$lon, sstmat$lat, apply(sstmat$data, 1:2, sum, na.rm=T), xlim = c(-100, 40), ylim = c(0,65))
# world(add=T, col = 'white')
# title('Number of months with suitable surface temperature')
```


\newpage

## Set up the temperature constraint field. 

This can be done several ways. The preferred method is to use a running average of suitability, by month, for 12 months. In this manner, there is not a hard limit as to whether a fish may be in the area or not, but does provide a selection criteria that is weighted toward the suitability in that month.

The temperature field provided `data(rmask)` is a surface temperature suitability for bluefin tuna, based on tag measured temperatures. 

```{r, plot_ecdf, eval = T, fig.show = 'asis',  fig.cap = 'Tag Measured Temperatures'}
dat = nsfish

par(mfrow=c(3,4))
for(i in 1:12){
	plot(ecdf(dat$MaxTemp[dat$Month==i]), main = month.name[i], xlab = '' ,ylab = '')
	# hist(dat$MaxTemp[seasidx[[i]]], breaks=30, main=seasons[i], xlim = c(0, 40))
	mtemp = mean(dat$MaxTemp[dat$Month==i], na.rm=T)
	sdtemp = sd(dat$MaxTemp[dat$Month==i], na.rm=T)
	abline(v=mtemp, lwd=2, col=2)
	abline(v=quantile(dat$MaxTemp[dat$Month==i], c(0.025, .975),na.rm=T), lwd=2, col=4)
	# print(quantile(dat$MaxTemp[dat$Month==i], c(0.025, .975),na.rm=T))
}
```
Based on the plots, a range of $10-28\,^{\circ}\mathrm{C}$ were chosen 

\newpage

```{r, sst_pref_plot, fig.cap = 'Number of months with suitable surface temperature'}
image.plot(sstmat$lon, sstmat$lat, apply(sstmat$data, 1:2, sum, na.rm=T), xlim = c(-100, 40), ylim = c(0,65), col = viridis(12), axes = F)
plot(map, add=T, col = 'white')
# world(add=T, col = 'white')
degAxis(1)
degAxis(2)
title('Number of months with suitable surface temperature')

```

```{r, sst_pref_plot_12months, fig.cap = 'Number of months with suitable surface temperature'}

par(mfrow=c(3,4))
for(i in 1:12){
  par(mar=c(1,1,2,1))
image(sstmat$lon, sstmat$lat, sstmat$data[,,i], xlim = c(-100, 40), ylim = c(0,65), col = hsv(.28, .9, .5, alpha = .5), axes = F)
plot(map, add=T, col = 'white')
box()
# world(add=T, col = 'white')
# degAxis(1)
# degAxis(2)
# degAxis(1, tck = 0.02, las = 2, hadj = -1)
# degAxis(2, tck = 0.02, las = 1, hadj = -1)
title(month.name[i])
}
# title('Number of months with suitable surface temperature')

```

\newpage

```{r, plot_sstdat, eval = F, fig.show = 'asis'}
# SET UP THE WOA SST AS A 3D ARRAY
# Function does not work!!!
# sstmat = rmask2array(rmask)
sstmat = list(lon = sort(unique(coordinates(rmask[[1]])[,1]))
                ,lat = sort(unique(coordinates(rmask[[1]])[,2]))
                # ,data = as.array(rmask)
                )
  sstdata = array(NA, dim = dim(rmask)[c(2,1,3)])
  for(i in 1:(dim(rmask)[3])) sstdata[,,i] = rot90(as.array(rmask)[,,i],3)
  # sstmat$data = apply(sstdata, 1:2, sum, na.rm = T)

sstmat$data = sstdata
## If using the running average suitability
{
  sstm = sstdata
  for(i in 2:11){
   sstm[,,i] = apply(sstdata[,,c(i-1,i,i+1)], 1:2, sum, na.rm = T)
  }
  sstm[,,1] = apply(sstdata[,,c(12, 1, 2)], 1:2, sum, na.rm = T)
  sstm[,,12] = apply(sstdata[,,c(11, 12, 1)], 1:2, sum, na.rm = T)

  sstmat$data = sstm
  rm(sstdata, sstm)
}


par(mfrow=c(3,4))
for(i in 1:12){
  par(mar=c(2,2,2,2))
 image(sstmat$lon, sstmat$lat, sstmat$data[,,i], col = tim.colors(4))
 world(add=T)
}
```

## Get parameters from tag data

```{r, get_params, echo = T}
par.ns = get.allpar(as.data.frame(nsfish))
d.ns = get.kfD(as.data.frame(nsfish))
simpar = merge.par(par.ns, d.ns, return.mean = T)
```

```{r, show_params_table}
knitr::kable(simpar, caption = 'Advection and Diffusion parameters for simulation. For these fish, a fixed diffusion was used during track estimation so there is no variance in D')
```

## Setup simulation parameters

```{r, echo = F, eval = T}

#------------------------------------------------------------------------#
# Set number of sims, simulation steps per month and number of years

msims = 25  # simulations to be started in each month
npmon = 30 # number of simulation steps per month.
nyears = 2 # number of years to simulate for each track
#------------------------------------------------------------------------#

simvals = data.frame(sim_param = c('msims','npmon','nyears'), value = c(25, 30, 2), description = c('simulations to be started in each month','number of simulation steps per month','number of years to simulate for each track'))

kable(simvals, caption = "Control parameters for simulation")

#------------------------------------------------------------------------#
# Set month order of simulaitons to correspond to release month
morder = array(rep(1:12, 12), dim=c(12, 12))

for(i in 1:12){
  if(i==1) morder[i,] = 1:12
  else morder[i,] = c(i:12,1:((1:12)[i]-1))
}
#------------------------------------------------------------------------#

morder = data.frame(morder, row.names = month.abb)
names(morder) = paste0('m',1:12)
kable(morder, caption = 'Month order for multi-month start simulation', row.names = T)
```

## Set up starting points for multi-start month simulation

Set any indices for size or other criteria here. 

```{r, eval = T, echo = T}
ns = as.data.frame(nsfish)
ns = ns[,c('TagID','Day','Month','Year','Longitude','Latitude')]
spts = get.start.pts(ns, msims, months = 1:12, posnames = c('Longitude','Latitude'))
str(spts)
```



## Run a single simulation in parallel

```{r, eval = T}

mcoptions = setup.parallel()

#---------------------------------------------------------------#
# SIMULATIONS

print(paste0('simulating ', length(spts)*msims, ' tracks for ', nyears, ' years'))
stime = Sys.time()
simdat = list()

cl = makeCluster(ncores)
registerDoParallel(cl, cores = ncores)

for(i in 1:12){
  subsp = spts[[i]][sample(1:nrow(spts[[i]]), msims, replace = T),]
  subsp$row = 1:nrow(subsp)
  sp = dlply(subsp, 'row', function(x) x[,1:2])
  simorder = as.numeric(morder[i,])
  
  print(paste0('simulating ', length(sp), ' tracks starting in ', month.name[i]))
  
  test = make.sim.track.par(tpar = simpar, morder = rep(simorder, nyears), sp = sp, bath = bath, sstmat = sstmat, seaslen = npmon, mcoptions = mcoptions)
  simdat[[i]] = test
  runtime = Sys.time()-stime
  print(paste0('elapsed time: ', runtime))
}

stopCluster(cl)
rm(test, sp, subsp)

simdat = unlist(simdat, recursive = F)
```

